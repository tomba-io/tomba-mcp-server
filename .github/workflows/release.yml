name: Release & Upload MCPB

on:
    push:
        tags:
            - "*"

jobs:
    build-pack-upload:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Build
              run: yarn build

            - name: MCPB Pack
              run: yarn pack

            - name: Write production certificate files
              run: |
                  echo "$PROD_CERT" > production-cert.pem
                  echo "$PROD_KEY" > production-key.pem
                  echo "$INTERMEDIATE_CA" > intermediate-ca.pem
                  echo "$ROOT_CA" > root-ca.pem
              env:
                  PROD_CERT: ${{ secrets.PROD_CERT }}
                  PROD_KEY: ${{ secrets.PROD_KEY }}
                  INTERMEDIATE_CA: ${{ secrets.INTERMEDIATE_CA }}
                  ROOT_CA: ${{ secrets.ROOT_CA }}

            - name: MCPB Sign (production)
              run: mcpb sign tomba-mcp-server.mcpb \
                  --cert production-cert.pem \
                  --key production-key.pem \
                  --intermediate intermediate-ca.pem \
                  --intermediate root-ca.pem

            - name: MCPB Verify
              run: mcpb verify tomba-mcp-server.mcpb

            - name: MCPB Info
              run: mcpb info tomba-mcp-server.mcpb

            - name: Upload MCPB artifact to release
              uses: softprops/action-gh-release@v2
              with:
                  files: tomba-mcp-server.mcpb
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
